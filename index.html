<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Чертов сайт</title>
    <base href="/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link id="faviconLink" rel="icon" type="image/x-icon" href="favicon.ico?v=4">
    <script src="https://checkout.cloudpayments.ru/checkout.js"></script>
  </head>
  <body>
    <form id="paymentFormSample" autocomplete="off" accept-charset="utf-8">
     Введите карту:
     <input type="text" data-cp="cardNumber" value='2200000022222222'> <br/>
     Введите месяц:
     <input type="text" data-cp="expDateMonth" value='01'> <br/>
     Введите год:
     <input type="text" data-cp="expDateYear" value='25'> <br/>
     Введите cvv:
     <input type="text" data-cp="cvv" value='777'> <br/>
     Введите имя с оборота карты:
     <input type="text" data-cp="name" value='VADIM GRUUUF'> <br/>
     
    </form>
    <button id="submitButton" type="submit">Оплатить 10 р.</button> <br/>
      <input id="subsCheckbox" type="checkbox">
      <label>Сделать платеж ежемесячным</label>
      <script>
    let crypto
    async function Submit()
        {
          let escrow = {
            StartAccumulation: true,
            EscrowType: 0
          }

          const myHeaders = new Headers();
          const basic = btoa('pk_aff17de359b486f45c12b4e4fdab0:161e5df19cdff1a23a01f76be4346ce9')
          myHeaders.append("Content-Type", "application/json");
          myHeaders.append("Access-Control-Allow-Headers", "Authorization");
          myHeaders.append("Authorization", "Basic " + basic);
          

          let response = await fetch("https://cors-anywhere.herokuapp.com/https://api.cloudpayments.ru/payments/cards/charge", {
                method: "POST",
                body: JSON.stringify({
                  Amount: 10,
                  IpAddress: "192.192.192.192",
                  CardCryptogramPacket: crypto,
                  AccountId: "user_x",
                  escrow: escrow
                }),
                headers: myHeaders
              });

          if (!response.ok)
          {
            console.log("Ошибка")
            console.log(response)
            
          }
          let resData = await response.json()
          console.log(resData)

          if (document.getElementById("subsCheckbox").checked)
          {
            const token = resData["Model"]["Token"]
            const date = new Date(Date.now().getTime() + 30*60000); // через 30 мин
            headers: myHeaders,
            response = await fetch("https://cors-anywhere.herokuapp.com/https://api.cloudpayments.ru/payments/subscriptions/create", {
                method: "POST",
                body: JSON.stringify({
                  Token: token,
                  Amount: 10,
                  Currency: "RUB",
                  RequireConfirmation: false,
                  StartDate:  date,
                  Interval: "Month",
                  Period:  1,
                  AccountId: "user_x",
                })
              });
              response.setHeader('Access-Control-Allow-Headers', '*');
          }

        
      }
    

      document.getElementById("submitButton").onclick=async() => {
          await Submit();
        };

        let containerData = document.getElementById("paymentFormSample")

        const checkout = new cp.Checkout({
          publicId: 'pk_aff17de359b486f45c12b4e4fdab0',
          APISecret: '161e5df19cdff1a23a01f76be4346ce9',
          container: document.getElementById("paymentFormSample")
        });

        checkout.createPaymentCryptogram()
            .then((cryptogram) => {
              console.log("Крипто готова")
              crypto = cryptogram
            }).catch((errors) => {
              console.log("Крипто не готова")
          });


    </script>
  </body>
</html>
<!--<style>
 p {
  color: red;
 }
 .text {
  font-size: 24px;
 }
</style>->
