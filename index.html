<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Чертов сайт</title>
    <base href="/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link id="faviconLink" rel="icon" type="image/x-icon" href="favicon.ico?v=4">
    <script src="https://checkout.cloudpayments.ru/checkout.js"></script>
    <script src="https://widget.cloudpayments.ru/bundles/cloudpayments.js"></script>
  </head>
  <body>
    <form id="paymentFormSample" autocomplete="off" accept-charset="utf-8">
     Введите почту:
     <input type="text" id="email" value='example@gmail.com'> <br/>
     Введите номер телефона:
     <input type="text" id="phone" value='89991234567'> <br/>
     Введите Фамилию:
     <input type="text" id="surname" value='Иванов'> <br/>
     Введите Имя:
     <input type="text" id="name" value='Иван'> <br/>
     Введите Отчество:
     <input type="text" id="lastname" value='Иванович'> <br/>
     Введите комментарии:
     <input type="text" id="decript" value='На Геншин'> <br/>
    </form>
    <button id="submitButton" type="submit">Оплатить 10 р.</button> <br/>
      <input id="subsCheckbox" type="checkbox">
      <label>Сделать платеж ежемесячным</label>
      <script>
    let crypto
    let wdg
    function addMinutes(date, minutes) {
      return new Date(date.getTime() + minutes*60000);
    }

    function pay()
    {
      const email = document.getElementById("email").value
      const phone = document.getElementById("phone").value
      const name = document.getElementById("name").value
      const surname = document.getElementById("surname").value
      const lastname = document.getElementById("lastname").value
      const descripton = document.getElementById("decript").value

      var widget = new cp.CloudPayments();

      if (document.getElementById("subsCheckbox").checked)
      {

      var receipt = {
      Items: [//товарные позиции
          {
            label: 'Паймон в Геншине', //наименование товара
            price: 10.00, //цена
            quantity: 1.00, //количество
            amount: 10.00, //сумма
            vat: 0, //ставка НДС
            method: 0, // тег-1214 признак способа расчета - признак способа расчета
            object: 0, // тег-1212 признак предмета расчета - признак предмета товара, работы, услуги, платежа, выплаты, иного предмета расчета
          }
        ],
      taxationSystem: 0, //система налогообложения; необязательный, если у вас одна система налогообложения
      email: email, //e-mail покупателя, если нужно отправить письмо с чеком
      phone: phone, //телефон покупателя в любом формате, если нужно отправить сообщение со ссылкой на чек
      isBso: false, //чек является бланком строгой отчетности
      amounts:
      {
        electronic: 10.00, // Сумма оплаты электронными деньгами
        advancePayment: 0.00, // Сумма из предоплаты (зачетом аванса) (2 знака после точки)
        credit: 0.00, // Сумма постоплатой(в кредит) (2 знака после точки)
        provision: 0.00 // Сумма оплаты встречным предоставлением (сертификаты, др. мат.ценности) (2 знака после точки)
      }
      };

      var data = {};
      data.CloudPayments = {
        CustomerReceipt: receipt, //чек для первого платежа
        recurrent: {
        interval: 'Month',
        period: 1, 
        customerReceipt: receipt //чек для регулярных платежей
      }
      }; //создание ежемесячной подписки

      widget.charge({ // options
        publicId: 'pk_aff17de359b486f45c12b4e4fdab0', //id из личного кабинета
        description: 'Ежемесячный донат в Геншине', //назначение
        amount: 10, //сумма
        currency: 'RUB', //валюта
        accountId: email, //идентификатор плательщика (обязательно для создания подписки)
        data: data,
        payer: { 
                firstName: name,
                lastName: surname,
                middleName: lastname,
                birth: '1955-02-24',
                address: 'тестовый проезд дом тест',
                street: 'Lenina',
                city: 'MO',
                country: 'RU',
                phone: '123',
                postcode: '345'
            }
      },
      function (options) { // success
      //действие при успешной оплате
      },
      function (reason, options) { // fail
      //действие при неуспешной оплате
      });
      }
      else 
      {
      
      widget.pay('charge', // или 'charge'
        { //options
            publicId: 'pk_aff17de359b486f45c12b4e4fdab0', //id из личного кабинета
            description: 'Донат Геншина', //назначение
            amount: 10, //сумма
            currency: 'RUB', //валюта
            accountId: email, //идентификатор плательщика (необязательно)
            email: email,
            skin: "mini", //дизайн виджета (необязательно)
            autoClose: 3, //время в секундах до авто-закрытия виджета (необязательный)
            data: {
                myProp: 'myProp value'
            },
            configuration: {
            },
            payer: { 
                firstName: name,
                lastName: surname,
                middleName: lastname,
                birth: '1955-02-24',
                address: 'тестовый проезд дом тест',
                street: 'Lenina',
                city: 'MO',
                country: 'RU',
                phone: '123',
                postcode: '345'
            }
        },
        {
            onSuccess: function (options) { // success
                //действие при успешной оплате
            },
            onFail: function (reason, options) { // fail
                //действие при неуспешной оплате
            },
            onComplete: function (paymentResult, options) { //Вызывается как только виджет получает от api.cloudpayments ответ с результатом транзакции.
                //например вызов вашей аналитики
            }
        })
    }
    }

    // async function Submit()
    //     {
    //       let escrow = {
    //         StartAccumulation: true,
    //         EscrowType: 0
    //       }

    //       const myHeaders = new Headers();
    //       const basic = btoa('pk_aff17de359b486f45c12b4e4fdab0:161e5df19cdff1a23a01f76be4346ce9')
    //       myHeaders.append("Content-Type", "application/json");
    //       myHeaders.append("Access-Control-Allow-Headers", "Authorization");
    //       myHeaders.append("Authorization", "Basic " + basic);
          
    //       let test = await fetch("https://cors-anywhere.herokuapp.com/https://api.cloudpayments.ru/payments/list")
    //       console.log("все: "  + JSON.stringify(await test.json()))

    //       let response = await fetch("https://cors-anywhere.herokuapp.com/https://api.cloudpayments.ru/payments/cards/auth", {
    //             method: "POST",
    //             body: JSON.stringify({
    //               Amount: 10,
    //               IpAddress: "192.192.192.192",
    //               CardCryptogramPacket: crypto,
    //               AccountId: "user_x",
    //               escrow: escrow,
    //               SaveCard: true
    //             }),
    //             headers: myHeaders
    //           });

    //       if (!response.ok)
    //       {
    //         console.log("Ошибка")
    //         console.log(response)
    //       }

    //       let resData = await response.json()
    //       console.log(resData)
    //       let trId = resData["Model"]["TransactionId"]

    //       let response1 = await fetch("https://cors-anywhere.herokuapp.com/https://api.cloudpayments.ru/payments/charge", {
    //             method: "POST",
    //             body: JSON.stringify({
    //               TransactionId: trId,
    //               Amount: 10
    //             }),
    //             headers: myHeaders
    //           });
    //           console.log("подтверждение: "  + JSON.stringify(await response1.json()))

    //       if (document.getElementById("subsCheckbox").checked)
    //       {

    //         const token = resData["Model"]["Token"]
    //         console.log("Токен: " + token)
    //         const date = addMinutes(new Date(Date.now()), 30)  // через 30 мин
    //         console.log("Дата: " + date.toISOString().slice(0, 19))
        
    //         response = await fetch("https://cors-anywhere.herokuapp.com/https://api.cloudpayments.ru/payments/subscriptions/create", {
    //             method: "POST",
    //             headers: myHeaders,
    //             body: JSON.stringify({
    //               Token: token,
    //               Amount: 10,
    //               Description: "Донат в Геншин",
    //               AccountId: "user_x",
    //               Currency: "RUB",
    //               Payer: {
    //                 Phone: "89991234567"
    //               },
    //               RequireConfirmation: true,
    //               StartDate:  date.toISOString().slice(0, 19),
    //               Interval: "Month",
    //               Period: 1
                  
    //             })
    //           });

    //           if (!response.ok)
    //           {
    //             console.log("Ошибка")
    //             console.log(response)
    //           }

    //           resData = await response.json()
    //           console.log(resData)

    //       }

        
    //   }
    

      document.getElementById("submitButton").onclick=async() => {
          pay()
        };

        // let containerData = document.getElementById("paymentFormSample")

        // const checkout = new cp.Checkout({
        //   publicId: 'pk_aff17de359b486f45c12b4e4fdab0',
        //   APISecret: '161e5df19cdff1a23a01f76be4346ce9',
        //   container: document.getElementById("paymentFormSample")
        // });

        // checkout.createPaymentCryptogram()
        //     .then((cryptogram) => {
        //       console.log("Крипто готова")
        //       crypto = cryptogram
        //     }).catch((errors) => {
        //       console.log("Крипто не готова")
        //   });


    </script>
  </body>
</html>
<!--<style>
 p {
  color: red;
 }
 .text {
  font-size: 24px;
 }
</style>->
