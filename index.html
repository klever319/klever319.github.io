<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Чертов сайт</title>
    <base href="/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link id="faviconLink" rel="icon" type="image/x-icon" href="favicon.ico?v=4">
    <script src="https://checkout.cloudpayments.ru/checkout.js"></script>
  </head>
  <body>
    <form id="paymentFormSample" autocomplete="off" accept-charset="utf-8">
     Введите карту:
     <input type="text" data-cp="cardNumber" value='2200000022222222'> <br/>
     Введите месяц:
     <input type="text" data-cp="expDateMonth" value='01'> <br/>
     Введите год:
     <input type="text" data-cp="expDateYear" value='25'> <br/>
     Введите cvv:
     <input type="text" data-cp="cvv" value='777'> <br/>
     Введите имя с оборота карты:
     <input type="text" data-cp="name" value='VADIM GRUUUF'> <br/>
     
    </form>
    <button id="submitButton" type="submit">Оплатить 10 р.</button> <br/>
      <input id="subsCheckbox" type="checkbox">
      <label>Сделать платеж ежемесячным</label>
      <script>
      let crypto

       function pay() {
          var widget = new cp.CloudPayments();

          var data = {};

          data.CloudPayments = {
            CustomerReceipt: receipt, //чек для первого платежа
            recurrent: {
            interval: 'Month',
            period: 1, 
            customerReceipt: receipt //чек для регулярных платежей
            }
          };

          widget.charge({ // options
            publicId: 'pk_aff17de359b486f45c12b4e4fdab0', //id из личного кабинета
            description: 'Подписка на ежемесячный доступ к сайту example.com', //назначение
            amount: 1000, //сумма
            currency: 'RUB', //валюта
            invoiceId: '1234567', //номер заказа  (необязательно)
            accountId: 'user@example.com', //идентификатор плательщика (обязательно для создания подписки)
            data: data
            },
            function (options) { // success
          //действие при успешной оплате
          },
          function (reason, options) { 
            console.log(reason)// fail
          //
        });


          widget.pay(
              "auth", //  'charge'
              {
                  //options
                  publicId: "pk_aff17de359b486f45c12b4e4fdab0", //id из личного кабинета
                  description: "example.com", //назначение
                  amount: 100, //сумма
                  currency: "RUB", //валюта (единственная поддерживаемая валюта)
                  accountId: "user@example.com", //идентификатор плательщика (необязательно)
                  invoiceId: "1234567", //номер заказа  (необязательно)
                  email: "user@example.com", //email плательщика (необязательно)
                  skin: "mini", //дизайн виджета (необязательно)
                  data: {
                      myProp: "myProp value",
                  },
                  escrow: { // объект описывающий безопасную сделку
                      startAccumulation: true, // - Используется для первой оплаты - для создания накопления
                      escrowType: cp.constant.escrow.NToOne,
                      AccumulationId: "4733183a-c6f6-4c1b-8ff1-fb7c43ed1695", // - Оплата по уже созданному накоплению.
                  }, // Объект escrow требует наличия поля startAccumulation со значением true, либо поля AccumulationId с id накопления, но не обоих одновременно
              }, {
                  onSuccess: function(options) {
                      console.log("успех")
                  },
                  onFail: function(reason, options) {
                    console.log("не успех")
                    console.log(reason)
                      // fail
                      // действие при неуспешной оплате
                  },
                  onComplete: function(paymentResult, options) {
                    console.log(paymentResult)
                      //  Вызывается как только виджет получает от api.cloudpayments ответ с результатом транзакции.
                  },
              }
          );
          console.log("выполнено")
}

      function subscibe()
      {
        widget.charge({ // options
          publicId: 'pk_aff17de359b486f45c12b4e4fdab0', //id из личного кабинета
          description: 'Подписка на ежемесячный доступ к сайту example.com', //назначение
          amount: 1000, //сумма
          currency: 'RUB', //валюта
          invoiceId: '1234567', //номер заказа  (необязательно)
          accountId: 'user@example.com', //идентификатор плательщика (обязательно для создания подписки)
          data: data
          },
          function (options) {
        },
        function (reason, options) { 
          console.log(reason)
        //
      });
    }
        
    async function Submit()
        {
          let escrow = {
            StartAccumulation: true,
            EscrowType: 0
          }


          const myHeaders = new Headers();
          myHeaders.append("Content-Type", "application/json");
          myHeaders.append("Authorization", "pk_aff17de359b486f45c12b4e4fdab0: 161e5df19cdff1a23a01f76be4346ce9");
          myHeaders.append("Access-Control-Allow-Headers", "Authorization");

          let response = await fetch("https://api.cloudpayments.ru/payments/cards/charge", {
                method: "POST",
                body: JSON.stringify({
                  Amount: 10,
                  IpAddress: "192.192.192.192",
                  CardCryptogramPacket: crypto,
                  AccountId: "user_x",
                  escrow: escrow
                }),
                headers: myHeaders
              });

          if (!response.ok)
          {
            console.log("Ошибка")
            console.log(response)
            
          }
          response.setHeader('Access-Control-Allow-Headers', '*');
          let resData = await response.json()
          

          if (document.getElementById("subsCheckbox").checked)
          {
            const token = resData["Model"]["Token"]
            const date = new Date(Date.now().getTime() + 30*60000); // через 30 мин
            headers: myHeaders,
            response = await fetch("https://api.cloudpayments.ru/payments/subscriptions/create", {
                method: "POST",
                body: JSON.stringify({
                  Token: token,
                  Amount: 10,
                  Currency: "RUB",
                  RequireConfirmation: false,
                  StartDate:  date,
                  Interval: "Month",
                  Period:  1,
                  AccountId: "user_x",
                })
              });
              response.setHeader('Access-Control-Allow-Headers', '*');
          }

        
      }
    

      document.getElementById("submitButton").onclick=async() => {
          await Submit();
        };

        let containerData = document.getElementById("paymentFormSample")

        const checkout = new cp.Checkout({
          publicId: 'pk_aff17de359b486f45c12b4e4fdab0',
          APISecret: '161e5df19cdff1a23a01f76be4346ce9',
          container: document.getElementById("paymentFormSample")
        });

        checkout.createPaymentCryptogram()
            .then((cryptogram) => {
              console.log("Крипто готова")
              crypto = cryptogram
            }).catch((errors) => {
              console.log("Крипто не готова")
          });


    </script>
  </body>
</html>
<!--<style>
 p {
  color: red;
 }
 .text {
  font-size: 24px;
 }
</style>->
