<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Чертов сайт</title>
    <base href="/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link id="faviconLink" rel="icon" type="image/x-icon" href="favicon.ico?v=4">
    <script src="https://checkout.cloudpayments.ru/checkout.js"></script>
    <script src="https://widget.cloudpayments.ru/bundles/cloudpayments.js"></script>
  </head>
  <body>
    <form id="paymentFormSample" autocomplete="off" accept-charset="utf-8">
     Введите карту:
     <input type="text" data-cp="cardNumber" value='2200000022222222'> <br/>
     Введите месяц:
     <input type="text" data-cp="expDateMonth" value='01'> <br/>
     Введите год:
     <input type="text" data-cp="expDateYear" value='25'> <br/>
     Введите cvv:
     <input type="text" data-cp="cvv" value='777'> <br/>
     Введите имя с оборота карты:
     <input type="text" data-cp="name" value='VADIM GRUUUF'> <br/>
     <input type="text" id="descript" value="На Геншин Импакт"> <br/>
    </form>
    <button id="submitButton" type="submit">Оплатить 10 р.</button> <br/>
      <input id="subsCheckbox" type="checkbox">
      <label>Сделать платеж ежемесячным</label>
      <script>
    let crypto
    let wdg
    function addMinutes(date, minutes) {
      return new Date(date.getTime() + minutes*60000);
    }

    function pay()
    {

      var widget = new cp.CloudPayments();
      widget.pay('charge', // или 'charge'
        { //options
            publicId: 'pk_aff17de359b486f45c12b4e4fdab0', //id из личного кабинета
            description: 'Донат Геншина', //назначение
            amount: 10, //сумма
            currency: 'RUB', //валюта
            accountId: 'user@example.com', //идентификатор плательщика (необязательно)
            invoiceId: '1234567', //номер заказа  (необязательно)
            email: 'user@example.com', //email плательщика (необязательно)
            skin: "mini", //дизайн виджета (необязательно)
            autoClose: 3, //время в секундах до авто-закрытия виджета (необязательный)
            data: {
                myProp: 'myProp value'
            },
            configuration: {
            },
            payer: { 
                firstName: 'Тест',
                lastName: 'Тестов',
                middleName: 'Тестович',
                birth: '1955-02-24',
                address: 'тестовый проезд дом тест',
                street: 'Lenina',
                city: 'MO',
                country: 'RU',
                phone: '123',
                postcode: '345'
            }
        },
        {
            onSuccess: function (options) { // success
                //действие при успешной оплате
            },
            onFail: function (reason, options) { // fail
                //действие при неуспешной оплате
            },
            onComplete: function (paymentResult, options) { //Вызывается как только виджет получает от api.cloudpayments ответ с результатом транзакции.
                //например вызов вашей аналитики
            }
        }
        
    )
    wdg = widget
    console.log(widget.status)

    }

    // async function Submit()
    //     {
    //       let escrow = {
    //         StartAccumulation: true,
    //         EscrowType: 0
    //       }

    //       const myHeaders = new Headers();
    //       const basic = btoa('pk_aff17de359b486f45c12b4e4fdab0:161e5df19cdff1a23a01f76be4346ce9')
    //       myHeaders.append("Content-Type", "application/json");
    //       myHeaders.append("Access-Control-Allow-Headers", "Authorization");
    //       myHeaders.append("Authorization", "Basic " + basic);
          
    //       let test = await fetch("https://cors-anywhere.herokuapp.com/https://api.cloudpayments.ru/payments/list")
    //       console.log("все: "  + JSON.stringify(await test.json()))

    //       let response = await fetch("https://cors-anywhere.herokuapp.com/https://api.cloudpayments.ru/payments/cards/auth", {
    //             method: "POST",
    //             body: JSON.stringify({
    //               Amount: 10,
    //               IpAddress: "192.192.192.192",
    //               CardCryptogramPacket: crypto,
    //               AccountId: "user_x",
    //               escrow: escrow,
    //               SaveCard: true
    //             }),
    //             headers: myHeaders
    //           });

    //       if (!response.ok)
    //       {
    //         console.log("Ошибка")
    //         console.log(response)
    //       }

    //       let resData = await response.json()
    //       console.log(resData)
    //       let trId = resData["Model"]["TransactionId"]

    //       let response1 = await fetch("https://cors-anywhere.herokuapp.com/https://api.cloudpayments.ru/payments/charge", {
    //             method: "POST",
    //             body: JSON.stringify({
    //               TransactionId: trId,
    //               Amount: 10
    //             }),
    //             headers: myHeaders
    //           });
    //           console.log("подтверждение: "  + JSON.stringify(await response1.json()))

    //       if (document.getElementById("subsCheckbox").checked)
    //       {

    //         const token = resData["Model"]["Token"]
    //         console.log("Токен: " + token)
    //         const date = addMinutes(new Date(Date.now()), 30)  // через 30 мин
    //         console.log("Дата: " + date.toISOString().slice(0, 19))
        
    //         response = await fetch("https://cors-anywhere.herokuapp.com/https://api.cloudpayments.ru/payments/subscriptions/create", {
    //             method: "POST",
    //             headers: myHeaders,
    //             body: JSON.stringify({
    //               Token: token,
    //               Amount: 10,
    //               Description: "Донат в Геншин",
    //               AccountId: "user_x",
    //               Currency: "RUB",
    //               Payer: {
    //                 Phone: "89991234567"
    //               },
    //               RequireConfirmation: true,
    //               StartDate:  date.toISOString().slice(0, 19),
    //               Interval: "Month",
    //               Period: 1
                  
    //             })
    //           });

    //           if (!response.ok)
    //           {
    //             console.log("Ошибка")
    //             console.log(response)
    //           }

    //           resData = await response.json()
    //           console.log(resData)

    //       }

        
    //   }
    

      document.getElementById("submitButton").onclick=async() => {
          pay()
        };

        let containerData = document.getElementById("paymentFormSample")

        const checkout = new cp.Checkout({
          publicId: 'pk_aff17de359b486f45c12b4e4fdab0',
          APISecret: '161e5df19cdff1a23a01f76be4346ce9',
          container: document.getElementById("paymentFormSample")
        });

        checkout.createPaymentCryptogram()
            .then((cryptogram) => {
              console.log("Крипто готова")
              crypto = cryptogram
            }).catch((errors) => {
              console.log("Крипто не готова")
          });


    </script>
  </body>
</html>
<!--<style>
 p {
  color: red;
 }
 .text {
  font-size: 24px;
 }
</style>->
